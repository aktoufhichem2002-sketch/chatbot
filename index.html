<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Fuse.js pour la recherche floue -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <meta charset="UTF-8">
    <title>Chatbot Web - Hichem</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <h2>Chatbot Web</h2>

        <div class="robot" aria-hidden="true">ðŸ¤–</div>

        <div id="chatbox"></div>

        <div class="input-zone">
            <input type="text" id="userInput" placeholder="Pose une question..." />
            <button id="sendBtn">Envoyer</button>
        </div>
    </div>

    <footer class="footer">Hichem Aktouf</footer>

    <script>
        let fuse = null;          // index Fuse (recherche floue)
        let connaissances = [];   // donnÃ©es JSON chargÃ©es
        let basePrete = false;    // prÃªt Ã  rÃ©pondre ?

        // 1) Charger la base et initialiser Fuse
        async function chargerConnaissances() {
            try {
                const res = await fetch("base_connaissances.json", { cache: "no-cache" });
                connaissances = await res.json();

                // Options Fuse : ajuste threshold (0 = strict, 1 = permissif)
                const options = {
                    keys: [
                        { name: "question", weight: 0.7 },
                        { name: "motscles", weight: 0.3 } // si prÃ©sent dans le JSON
                    ],
                    includeScore: true,
                    threshold: 0.38,   // bon compromis FR (typos lÃ©gÃ¨res + paraphrases)
                    ignoreLocation: true,
                    minMatchCharLength: 2,
                    distance: 100
                };

                fuse = new Fuse(connaissances, options);
                basePrete = true;

                // Message d'accueil quand c'est prÃªt
                ajouterMessage("bot", "Salut ! Je peux comprendre des formulations proches. Essaye par ex. : Â« DÃ©clarer variable TwinCAT Â», Â« câ€™est quoi TON ? Â», Â« boucle for Python Â».");
            } catch (e) {
                console.error(e);
                ajouterMessage("bot", "Impossible de charger la base de connaissances. VÃ©rifie le fichier base_connaissances.json.");
            }
        }

        // 2) Affichage des messages
        function ajouterMessage(auteur, message) {
            const chatbox = document.getElementById("chatbox");
            const div = document.createElement("div");
            div.className = `msg ${auteur}`;
            div.textContent = message;
            chatbox.appendChild(div);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // 3) Trouver une rÃ©ponse avec recherche floue
        function trouverReponse(questionUtilisateur) {
            if (!basePrete || !fuse) {
                return { type: "status", text: "Chargement des connaissancesâ€¦ rÃ©essaye dans une seconde." };
            }

            const q = questionUtilisateur.trim();
            if (!q) {
                return { type: "status", text: "Pose une question pour commencer ðŸ˜Š" };
            }

            const resultats = fuse.search(q);

            if (resultats.length === 0) {
                return {
                    type: "unknown",
                    text: "Je ne connais pas encore cette question. Essaie de reformuler ou ajoute-la dans base_connaissances.json."
                };
            }

            // Meilleure correspondance
            const meilleur = resultats[0];
            const score = meilleur.score ?? 1;  // 0 = parfait, proche de 1 = Ã©loignÃ©
            const confiance = 1 - score;        // on renverse pour afficher une â€œconfianceâ€

            // Seuils de confiance (ajuste selon ton JSON)
            if (confiance >= 0.60) {
                return { type: "answer", text: meilleur.item.reponse, confiance };
            }

            // Sinon : proposer des suggestions
            const suggestions = resultats.slice(0, 3).map(r => r.item.question);
            return {
                type: "suggest",
                text: "Je ne suis pas sÃ»r dâ€™avoir bien compris. Tu voulais dire :",
                suggestions,
                confiance
            };
        }

        // 4) Envoi du message
        function sendMessage() {
            const input = document.getElementById("userInput");
            const question = input.value.trim();
            if (question === "") return;

            ajouterMessage("user", question);
            input.value = "";

            const res = trouverReponse(question);

            if (res.type === "answer") {
                ajouterMessage("bot", res.text + `\n(Confiance ~ ${(res.confiance * 100).toFixed(0)}%)`);
            } else if (res.type === "suggest") {
                ajouterMessage("bot", res.text + "\n- " + res.suggestions.join("\n- "));
            } else {
                ajouterMessage("bot", res.text);
            }
        }

        // 5) Bind UI
        document.getElementById("sendBtn").addEventListener("click", sendMessage);
        document.getElementById("userInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        // 6) DÃ©marrage
        // Message initial rapide (avant chargement)
        ajouterMessage("bot", "Chargement de la baseâ€¦");
        chargerConnaissances();
    </script>

</body>
</html>
